###############################################################################
#                                                                             #
#  PACKAGE:  Serial to Socket Relay scripts (ser2sock-scripts)                #
#     FILE:  install                                                          #
#    TITLE:  Build and install the ser2sock package from Nu Tech Software     #
#            Solutions, Inc.                                                  #
# FUNCTION:  Builds the ser2sock package from Nu Tech Software Solutions and  #
#            installs the resulting executable.                               #
#    USAGE:  Use with papamac's personal package utility (p2pkg).  See below. #
#   AUTHOR:  papamac                                                          #
#  VERSION:  1.0.4                                                            #
#     DATE:  December 14, 2025                                                #
#                                                                             #
#                                                                             #
# UNLICENSE:                                                                  #
#                                                                             #
# This is free and unencumbered software released into the public domain.     #
#                                                                             #
# Anyone is free to copy, modify, publish, use, compile, sell, or distribute  #
# this software, either in source code form or as a compiled binary, for any  #
# purpose, commercial or non-commercial, and by any means.                    #
#                                                                             #
# In jurisdictions that recognize copyright laws, the author or authors of    #
# this software dedicate any and all copyright interest in the software to    #
# the public domain. We make this dedication for the benefit of the public at #
# large and to the detriment of our heirs and successors. We intend this      #
# dedication to be an overt act of relinquishment in perpetuity of all        #
# present and future rights to this software under copyright law.             #
#                                                                             #
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  #
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    #
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL    #
# THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN #
# AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN        #
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.  #
#                                                                             #
# For more information, please refer to <https://unlicense.org/>              #
#                                                                             #
#                                                                             #
# DESCRIPTION:                                                                #
#                                                                             #
# The Serial to Socket Relay (ser2sock) is a program written by Sean Mathews  #
# of Nu Tech Software Solutions, Inc. to relay data from a serial port to one #
# or more socket connections.  ser2sock is used by papamac's AlarmDecoder-    #
# Bridge package to access serial data from Nu Tech's AD2USB or AD2PI.        #
#                                                                             #
# Nu Tech's ser2sock repository is located at github.com/nutechsoftware/      #
# ser2sock.  The current  version (master branch v1.5.5), implements the      #
# Secure Socket Layer (SSL) protocol for all socket connections.  This        #
# feature, although desirable, creates a lot of complexity in building an     #
# executable.  The github build scripts for v1.5.5 seem to be incompatible    #
# with the tools provided by current Raspberry Pi OS distribution.  To        #
# maintain compatibility across various Raspberry Pi distributions, this      #
# install script requires the non-SSL ser2sock V1.3.1 that can be compiled    #
# easily without SSL libraries.  This works because papamac's AlarmDecoder-   #
# Bridge application does not require SSL.                                    #
#                                                                             #
# install is designed to be used with papamac's personal package utility      #
# (p2pkg).  A call to p2pkg -gi bash-scripts clones the bash-scripts files    #
# (including install) and then executes the install script.  install starts   #
# by cloning the Nu Tech ser2sock repository (V1.3.1) into the src/ser2sock   #
# directory using an embedded call to p2pkg.  It then builds a ser2sock       #
# executable in the bin directory.  install does not install or start the     #
# ser2sock daemon.  Use the option script to do this after install completes. #
#                                                                             #
# cd /usr/local                        # Use the usr/local directory.         #
# sudo p2pkg -gi ser2sock-scripts      # Clone ser2sock-scripts into          #
#                                        /usr/local/src/ser2sock-scripts,     #
#                                        clone ser2sock into /usr/local/src/  #
#                                        ser2sock, and build/install ser2sock #
#                                        in /usr/local/bin.                   #
#                                                                             #
###############################################################################

# Download ser2sock source code from github nutechsoftware repository.

export GIT_ADVICE=0
p2pkg -y -b V1.3.1 -G nutechsoftware ser2sock
exit_code=$?

# Ensure that the ser2sock source has been downloaded.

# shellcheck disable=SC2154
if [[ $exit_code != 0 || ! -f $src/ser2sock/ser2sock.c ]]; then
    errmsg "ser2sock source not downloaded; $pkg_name install aborted"
    exit 11
fi

# Build and install ser2sock:

# shellcheck disable=SC2154
infomsg "building/installing $g${t}ser2sock$n in $b$t$bin$n"
cc -o "$bin"/ser2sock "$src"/ser2sock/ser2sock.c
